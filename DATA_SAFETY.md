# Сохранность данных и политика бэкапов

Цель: **никакие данные не теряются**, все действия логируются, есть надёжная политика бэкапов.

---

## 1. Аудит (логирование действий)

Все важные изменения записываются в **Лог действий** (раздел в приложении и коллекция `AuditLog` в БД):

- **Создание и изменение:** пользователи, роли, комнаты, циклы, нарезки клонов, бэтчи вегетации, бэтчи селекции, планы, урожай, архивы (обновление).
- **Удаление:** при каждом удалении перед удалением пишется запись с типом сущности, id и **деталями** (название, ключевые поля), чтобы можно было восстановить контекст. Удаление выполняется как **мягкое** (soft delete): запись помечается датой удаления и скрывается из списков, но остаётся в БД. В разделе **Корзина** (доступ по праву «Лог действий») можно просмотреть удалённые нарезки клонов, бэтчи вегетации и селекции, архивы и задачи и **восстановить** их одной кнопкой. Срок хранения удалённых записей — до ручной очистки (при желании можно настроить автоматическое безвозвратное удаление, например, через 90 дней).

Запись аудита содержит: кто (пользователь), что сделал (action), тип и id сущности, детали (details), IP, время. Лог **не удаляется** при удалении самих данных — история остаётся.

**Рекомендация:** не удалять записи из `AuditLog`. При необходимости освободить место — экспортировать старые записи в файл и только потом чистить (или увеличить объём БД).

---

## 2. Что бэкапить

| Что | Как | Частота |
|-----|-----|--------|
| **Код и конфиг** | `.\backup.ps1` | Перед большими изменениями, раз в неделю |
| **База MongoDB** | `.\backup-db.ps1` или бэкапы Atlas | Ежедневно или по расписанию |
| **Переменные окружения** | Копируются в папку бэкапа скриптом `backup.ps1` (server\.env) | Вместе с бэкапом кода |

- **Код:** папка проекта без `node_modules` и `.git`. В бэкап попадает и `server\.env` (пароли и URI БД хранятся только у вас).
- **БД:** все коллекции (пользователи, комнаты, клоны, вегетация, селекция, урожай, архивы, **логи аудита**). Без дампа БД при падении сервера или случайном удалении данных восстановить их из кода нельзя.

---

## 3. Скрипты бэкапа

### 3.1 Бэкап кода и конфига

```powershell
cd "C:\Users\Stepa\Desktop\Harvest scale\ClodV4"
.\backup.ps1
```

Создаётся папка `ClodV4-backup-ГГГГ-ММ-ДД_ЧЧ-ММ` рядом с проектом. Внутри — код и копия `server\.env`.

### 3.2 Бэкап базы (MongoDB)

**Локальная MongoDB или доступ по URI:**

```powershell
.\backup-db.ps1
```

Нужно: в `server\.env` задан `MONGODB_URI`, в системе установлены [MongoDB Database Tools](https://www.mongodb.com/docs/database-tools/installation/installation/) (команда `mongodump`). Создаётся папка `ClodV4-db-dump-ГГГГ-ММ-ДД_ЧЧ-ММ` с дампом.

**MongoDB Atlas:** в консоли Atlas включите **Continuous Backup** (или снимки по расписанию). Тогда бэкап БД делается в облаке, отдельно от скриптов.

---

## 4. Восстановление

### Из бэкапа кода

1. Скопировать нужную папку `ClodV4-backup-...` в рабочее место, при необходимости переименовать.
2. В корне: `npm install`, в `client` и `server` — `npm install`.
3. Файл `server\.env` уже лежит в бэкапе; при необходимости подправить (например, новый URI БД).

### Из дампа MongoDB

```powershell
mongorestore --uri="ВАШ_MONGODB_URI" --drop "путь\к\папке\ClodV4-db-dump-..."
```

`--drop` перед восстановлением удалит текущие коллекции. Без `--drop` данные из дампа добавятся к существующим (возможны дубликаты по _id).

### После сбоя

1. Восстановить код из последнего бэкапа (или из Git).
2. Восстановить БД из последнего дампа (или из бэкапов Atlas).
3. Проверить `server\.env` (MONGODB_URI, JWT-секреты).

---

## 5. Рекомендуемый график

- **Ежедневно (или после смены):** дамп БД (`backup-db.ps1` или Atlas).
- **Перед обновлением или раз в неделю:** полный бэкап кода `.\backup.ps1`.
- **После важных изменений:** коммит в Git и пуш (история версий + деплой).

Так данные, логи и конфиг сохраняются, а восстановление возможно из кода + дампа БД.
